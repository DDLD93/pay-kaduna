openapi: 3.0.0
info:
  title: PayKaduna Integration API
  version: 1.0.0
  description: |
    REST API gateway for PayKaduna Intelligent Billing System.
    
    Handles HMAC signing, request formatting, and error handling.

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: Bills
    description: Bill management endpoints
  - name: Taxpayers
    description: Taxpayer management endpoints
  - name: Payments
    description: Payment endpoints
  - name: Configuration
    description: Configuration endpoints
  - name: Webhooks
    description: Webhook endpoints for receiving events
  - name: Analytics
    description: Analytics and aggregation endpoints

paths:
  /v1/bills:
    post:
      tags:
        - Bills
      summary: Create a single bill
      description: Create an electronic bill for a taxpayer
      operationId: createBill
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBillRequest'
            example:
              identifier: "TAXPAYER123"
              firstName: "John"
              middleName: "Doe"
              lastName: "Smith"
              telephone: "+2348012345678"
              address: "123 Main Street, Kaduna"
              engineCode: "185477"
              esBillDetailsDto:
                - amount: 10000.00
                  mdasId: 1
                  narration: "Property Tax"
                  recommendedRate: 0.05
      responses:
        '200':
          description: Bill created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateBillResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      tags:
        - Bills
      summary: Get all bills
      description: |
        Fetch all bills with comprehensive filtering, range queries, pagination, and sorting.
        
        Supports:
        - Text search: billReference, invoiceNo (partial match, case-insensitive)
        - Exact filters: status, head, subhead
        - Date ranges: createdAt, updatedAt, paidAt
        - Amount ranges: minAmount, maxAmount (based on total bill amount)
        - Pagination: page and limit
        - Sorting: by createdAt, updatedAt, or paidAt (asc/desc)
      operationId: getAllBills
      parameters:
        - name: billReference
          in: query
          required: false
          schema:
            type: string
          description: Filter by bill reference (partial match, case-insensitive)
        - name: invoiceNo
          in: query
          required: false
          schema:
            type: string
          description: Filter by invoice number (partial match, case-insensitive)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by payment status (exact match)
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by revenue head (exact match)
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by revenue subhead (exact match)
        - name: createdAtStart
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filter bills created after this date (ISO 8601)
        - name: createdAtEnd
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filter bills created before this date (ISO 8601)
        - name: updatedAtStart
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filter bills updated after this date (ISO 8601)
        - name: updatedAtEnd
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filter bills updated before this date (ISO 8601)
        - name: paidAtStart
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filter bills paid after this date (ISO 8601)
        - name: paidAtEnd
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filter bills paid before this date (ISO 8601)
        - name: minAmount
          in: query
          required: false
          schema:
            type: number
            format: double
          description: Filter bills with total amount >= minAmount
        - name: maxAmount
          in: query
          required: false
          schema:
            type: number
            format: double
          description: Filter bills with total amount <= maxAmount
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page (max 100)
        - name: sortBy
          in: query
          required: false
          schema:
            type: string
            enum: [createdAt, updatedAt, paidAt]
            default: createdAt
          description: Field to sort by
        - name: sortOrder
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order (ascending or descending)
      responses:
        '200':
          description: Bills retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetAllBillsResponse'
              example:
                data:
                  - billReference: "BILL123456"
                    payStatus: "paid"
                    narration: "Property Tax Payment"
                    invoiceNo: "INV123456"
                    invoiceUrl: "https://example.com/invoice/123456"
                    head: "Revenue Head 1"
                    subhead: "Subhead A"
                    paidAt: "2025-01-15T10:30:00.000Z"
                    createdAt: "2025-01-10T08:00:00.000Z"
                    updatedAt: "2025-01-15T10:30:00.000Z"
                    billItems:
                      - id: 1
                        revenueHead: "Revenue Head 1"
                        revenueCode: "CODE123"
                        amount: 10000.00
                        mdasId: 1
                        narration: "Property Tax"
                pagination:
                  page: 1
                  limit: 20
                  totalCount: 150
                  totalPages: 8
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bills/bulk:
    post:
      tags:
        - Bills
      summary: Create bulk bills
      description: Create multiple bills in one request
      operationId: createBulkBills
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkBillRequest'
      responses:
        '200':
          description: All bills created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateBillResponse'
        '207':
          description: Partial success, some bills failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateBillResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bills/{reference}:
    get:
      tags:
        - Bills
      summary: Get bill by reference
      description: Get bill details by reference number
      operationId: getBill
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
          description: Bill reference number
      responses:
        '200':
          description: Bill retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Bill'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bills/{reference}/invoice-url:
    get:
      tags:
        - Bills
      summary: Get invoice URL
      description: Get payment invoice URL for a bill
      operationId: getInvoiceUrl
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
          description: Bill reference number
      responses:
        '200':
          description: Invoice URL retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceUrlResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bills/{reference}/metadata:
    post:
      tags:
        - Bills
      summary: Attach metadata to bill
      description: Add custom metadata to a bill
      operationId: attachMetadata
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
          description: Bill reference number
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttachDataRequest'
      responses:
        '200':
          description: Metadata attached successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bills/metadata/bulk:
    post:
      tags:
        - Bills
      summary: Bulk attach metadata
      description: Add custom metadata to multiple bills
      operationId: bulkAttachMetadata
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkAttachDataRequest'
      responses:
        '200':
          description: Metadata attached
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/taxpayers:
    post:
      tags:
        - Taxpayers
      summary: Register taxpayer
      description: Register a new taxpayer (Individual or Corporate)
      operationId: registerTaxpayer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterTaxpayerRequest'
      responses:
        '201':
          description: Taxpayer registered
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/taxpayers/search:
    get:
      tags:
        - Taxpayers
      summary: Search taxpayers
      description: Search by name, TPUI, TIN, NIN, phone, or email
      operationId: searchTaxpayer
      parameters:
        - name: term
          in: query
          required: true
          schema:
            type: string
            minLength: 4
          description: Search term, minimum 4 characters
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Taxpayer'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/payments/initialize:
    post:
      tags:
        - Payments
      summary: Initialize payment
      description: Start payment for a bill
      operationId: initializePayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitPaymentRequest'
      responses:
        '200':
          description: Payment initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitPaymentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/configuration/redirect-url:
    put:
      tags:
        - Configuration
      summary: Update redirect URL
      description: Set payment redirect URL
      operationId: updateRedirectUrl
      parameters:
        - name: redirectUrl
          in: query
          required: true
          schema:
            type: string
            format: uri
          description: Redirect URL
      responses:
        '200':
          description: Redirect URL updated
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/paykaduna/webhook:
    post:
      tags:
        - Webhooks
      summary: Webhook endpoint
      description: |
        Receive webhook events from PayKaduna.
        
        **Authentication:**
        Include HMAC-SHA512 signature in `x-paykaduna-signature` header.
        
        **Signature:**
        Generate using: `HMAC-SHA512(JSON.stringify(requestBody), secretKey).hex()`
        Use the exact JSON string from the request body.
        
        **Request Format:**
        Include `event`, `data` (with `invoiceNo` as string), and `message` fields.
        
        **Event Types:**
        - `charge.success` or `payment.success`: Payment completed
        - `payment.error`: Payment failed
        - Custom: Any string value
      operationId: handleWebhook
      parameters:
        - name: x-paykaduna-signature
          in: header
          required: true
          schema:
            type: string
          description: HMAC-SHA512 signature
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
            examples:
              paymentSuccess:
                summary: Payment success event
                value:
                  event: "charge.success"
                  data:
                    invoiceNo: "INV123456"
                    billReference: "BILL123456"
                    amount: 10000.00
                    status: "paid"
                    transactionId: "TXN789"
                    timestamp: "2025-01-15T10:30:00Z"
                  message: "Payment completed successfully"
              paymentError:
                summary: Payment error event
                value:
                  event: "payment.error"
                  data:
                    invoiceNo: "INV123456"
                    billReference: "BILL123456"
                    transactionId: "TXN789"
                  message: "Payment processing failed"
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookEvent'
              example:
                event: "charge.success"
                data:
                  invoiceNo: "INV123456"
                  billReference: "BILL123456"
                  amount: 10000.00
                  status: "paid"
                message: "Webhook event processed successfully"
        '400':
          description: Invalid request format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookEvent'
              example:
                event: "webhook.error"
                data: {}
                message: "Invalid request: event is required and must be a string"
        '401':
          description: Invalid or missing signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookEvent'
              examples:
                missingSignature:
                  value:
                    event: "webhook.error"
                    data: {}
                    message: "Webhook signature is required"
                invalidSignature:
                  value:
                    event: "webhook.error"
                    data: {}
                    message: "Webhook signature validation failed"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookEvent'
              example:
                event: "webhook.error"
                data: {}
                message: "Internal server error"

  /v1/analytics/status:
    get:
      tags:
        - Analytics
      summary: Get analytics by status
      description: Get aggregated analytics grouped by bill status (payStatus)
      operationId: getAnalyticsByStatus
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering by paidAt (ISO 8601 format)
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering by paidAt (ISO 8601 format)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific status
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by head
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by subhead
      responses:
        '200':
          description: Analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'
              example:
                groupBy: "status"
                totalCount: 150
                totalSum: 1500000.00
                totalAverage: 10000.00
                totalMin: 500.00
                totalMax: 50000.00
                items:
                  - groupBy: "status"
                    value: "paid"
                    count: 100
                    sum: 1000000.00
                    average: 10000.00
                    min: 500.00
                    max: 50000.00
                  - groupBy: "status"
                    value: "pending"
                    count: 50
                    sum: 500000.00
                    average: 10000.00
                    min: 1000.00
                    max: 30000.00
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/analytics/head:
    get:
      tags:
        - Analytics
      summary: Get analytics by head
      description: Get aggregated analytics grouped by head
      operationId: getAnalyticsByHead
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering by paidAt (ISO 8601 format)
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering by paidAt (ISO 8601 format)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific status
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by head
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by subhead
      responses:
        '200':
          description: Analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/analytics/subhead:
    get:
      tags:
        - Analytics
      summary: Get analytics by subhead
      description: Get aggregated analytics grouped by subhead
      operationId: getAnalyticsBySubhead
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering by paidAt (ISO 8601 format)
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering by paidAt (ISO 8601 format)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific status
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by head
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by subhead
      responses:
        '200':
          description: Analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/analytics/paid-at:
    get:
      tags:
        - Analytics
      summary: Get analytics by paidAt
      description: Get aggregated analytics grouped by paidAt date (only includes paid bills)
      operationId: getAnalyticsByPaidAt
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering by paidAt (ISO 8601 format)
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering by paidAt (ISO 8601 format)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific status
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by head
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by subhead
      responses:
        '200':
          description: Analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'
              example:
                groupBy: "paidAt"
                totalCount: 100
                totalSum: 1000000.00
                totalAverage: 10000.00
                totalMin: 500.00
                totalMax: 50000.00
                items:
                  - groupBy: "paidAt"
                    value: "2025-01-15"
                    count: 50
                    sum: 500000.00
                    average: 10000.00
                    min: 500.00
                    max: 50000.00
                  - groupBy: "paidAt"
                    value: "2025-01-16"
                    count: 50
                    sum: 500000.00
                    average: 10000.00
                    min: 1000.00
                    max: 30000.00
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/analytics/status-head:
    get:
      tags:
        - Analytics
      summary: Get analytics by status and head
      description: Get aggregated analytics grouped by status and head (multi-dimensional)
      operationId: getAnalyticsByStatusAndHead
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering by paidAt (ISO 8601 format)
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering by paidAt (ISO 8601 format)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific status
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by head
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by subhead
      responses:
        '200':
          description: Analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'
              example:
                groupBy: "status-head"
                totalCount: 150
                totalSum: 1500000.00
                totalAverage: 10000.00
                totalMin: 500.00
                totalMax: 50000.00
                items:
                  - groupBy: "status-head"
                    value: '{"status":"paid","head":"Revenue Head 1"}'
                    count: 75
                    sum: 750000.00
                    average: 10000.00
                    min: 500.00
                    max: 50000.00
                  - groupBy: "status-head"
                    value: '{"status":"pending","head":"Revenue Head 1"}'
                    count: 75
                    sum: 750000.00
                    average: 10000.00
                    min: 1000.00
                    max: 30000.00
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/analytics/status-head-subhead:
    get:
      tags:
        - Analytics
      summary: Get analytics by status, head, and subhead
      description: Get aggregated analytics grouped by status, head, and subhead (full multi-dimensional)
      operationId: getAnalyticsByStatusHeadSubhead
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering by paidAt (ISO 8601 format)
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering by paidAt (ISO 8601 format)
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Filter by specific status
        - name: head
          in: query
          required: false
          schema:
            type: string
          description: Filter by head
        - name: subhead
          in: query
          required: false
          schema:
            type: string
          description: Filter by subhead
      responses:
        '200':
          description: Analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsResponse'
              example:
                groupBy: "status-head-subhead"
                totalCount: 150
                totalSum: 1500000.00
                totalAverage: 10000.00
                totalMin: 500.00
                totalMax: 50000.00
                items:
                  - groupBy: "status-head-subhead"
                    value: '{"status":"paid","head":"Revenue Head 1","subhead":"Subhead A"}'
                    count: 50
                    sum: 500000.00
                    average: 10000.00
                    min: 500.00
                    max: 50000.00
                  - groupBy: "status-head-subhead"
                    value: '{"status":"paid","head":"Revenue Head 1","subhead":"Subhead B"}'
                    count: 25
                    sum: 250000.00
                    average: 10000.00
                    min: 1000.00
                    max: 30000.00
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    CreateBillRequest:
      type: object
      required:
        - identifier
        - firstName
        - lastName
        - telephone
        - address
        - esBillDetailsDto
      properties:
        identifier:
          type: string
          description: Taxpayer ID or TPUI
        firstName:
          type: string
        middleName:
          type: string
        lastName:
          type: string
        telephone:
          type: string
        address:
          type: string
        engineCode:
          type: string
          description: Optional engine code
        esBillDetailsDto:
          type: array
          items:
            $ref: '#/components/schemas/EsBillDetailDto'

    EsBillDetailDto:
      type: object
      required:
        - amount
        - mdasId
        - narration
      properties:
        amount:
          type: number
          format: double
        mdasId:
          type: integer
          description: Revenue Head ID
        narration:
          type: string
        recommendedRate:
          type: number
          format: double

    BulkBillRequest:
      type: object
      properties:
        engineCode:
          type: string
        esBillDtos:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/CreateBillRequest'
              - type: object
                properties:
                  engineCode:
                    type: string

    Bill:
      type: object
      properties:
        billReference:
          type: string
        payStatus:
          type: string
        narration:
          type: string
          nullable: true
        invoiceNo:
          type: string
          nullable: true
        invoiceUrl:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        head:
          type: string
          nullable: true
          description: Revenue head identifier
        subhead:
          type: string
          nullable: true
          description: Revenue subhead identifier
        paidAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when bill was paid
        createdAt:
          type: string
          format: date-time
          description: Timestamp when bill was created
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when bill was last updated

    BillItem:
      type: object
      properties:
        id:
          type: integer
          description: Bill item ID
        revenueHead:
          type: string
        revenueCode:
          type: string
        amount:
          type: number
          format: double
        mdasId:
          type: integer
          nullable: true
        narration:
          type: string
          nullable: true

    BillDetail:
      type: object
      description: Bill with all details and items
      allOf:
        - $ref: '#/components/schemas/Bill'
        - type: object
          properties:
            billItems:
              type: array
              items:
                $ref: '#/components/schemas/BillItem'

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: Current page number
        limit:
          type: integer
          description: Number of items per page
        totalCount:
          type: integer
          description: Total number of items
        totalPages:
          type: integer
          description: Total number of pages

    GetAllBillsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BillDetail'
        pagination:
          $ref: '#/components/schemas/Pagination'

    CreateBillResponse:
      type: object
      properties:
        bill:
          $ref: '#/components/schemas/Bill'
        billItems:
          type: array
          items:
            $ref: '#/components/schemas/BillItem'
        failedBillItems:
          type: array
          items:
            $ref: '#/components/schemas/BillItem'

    AttachDataRequest:
      type: object
      required:
        - billReference
        - additionalData
      properties:
        billReference:
          type: string
        additionalData:
          type: object
          additionalProperties: true

    BulkAttachDataRequest:
      type: object
      required:
        - bills
      properties:
        bills:
          type: array
          items:
            type: object
            required:
              - billReference
              - additionalData
            properties:
              billReference:
                type: string
              additionalData:
                type: object
                additionalProperties: true

    InvoiceUrlResponse:
      type: object
      properties:
        invoiceUrl:
          type: string
          format: uri

    RegisterTaxpayerRequest:
      type: object
      required:
        - identifier
        - firstName
        - lastName
        - tin
        - email
        - phoneNumber
        - genderId
        - addressLine1
        - userType
        - password
        - confirmPassword
      properties:
        identifier:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        middleName:
          type: string
        tin:
          type: string
        email:
          type: string
          format: email
        phoneNumber:
          type: string
        genderId:
          type: integer
          enum: [1, 2, 3]
          description: 1=Female, 2=Male, 3=NotSpecified
        addressLine1:
          type: string
        userType:
          type: string
          enum: [Individual, Corporate]
        password:
          type: string
          format: password
        confirmPassword:
          type: string
          format: password
        rcNumber:
          type: string
          description: Required for Corporate
        industryId:
          type: integer
          description: Required for Corporate
        officeName:
          type: string
        officeEmail:
          type: string
          format: email
        officePhoneNumber:
          type: string
        officeAddressLine1:
          type: string
        officeStateId:
          type: integer
        officeLgaId:
          type: integer
        taxStationId:
          type: integer

    Taxpayer:
      type: object
      properties:
        identifier:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        middleName:
          type: string
        tin:
          type: string
        email:
          type: string
        phoneNumber:
          type: string
        tpui:
          type: string

    InitPaymentRequest:
      type: object
      required:
        - tpui
        - billReference
      properties:
        tpui:
          type: string
        billReference:
          type: string

    InitPaymentResponse:
      type: object
      properties:
        checkoutUrl:
          type: string
          format: uri
        rawResponse:
          type: object
          additionalProperties: true

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: string
        statusCode:
          type: integer

    ErrorResponse:
      type: object
      properties:
        error:
          $ref: '#/components/schemas/Error'

    WebhookEvent:
      type: object
      required:
        - event
        - data
        - message
      properties:
        event:
          type: string
          description: Event type (e.g., 'charge.success', 'payment.success', 'payment.error')
          example: "charge.success"
        data:
          type: object
          description: Event data (must include invoiceNo)
          additionalProperties: true
          properties:
            invoiceNo:
              type: string
              description: Invoice number
              example: "INV123456"
          example:
            invoiceNo: "INV123456"
            billReference: "BILL123456"
            amount: 10000.00
            status: "paid"
        message:
          type: string
          description: Event message
          example: "Payment completed successfully"

    AggregationResult:
      type: object
      properties:
        groupBy:
          type: string
          description: The field used for grouping
          example: "status"
        value:
          type: string
          nullable: true
          description: The grouped value (or JSON string for multi-dimensional)
          example: "paid"
        count:
          type: integer
          description: Number of bill items in this group
          example: 100
        sum:
          type: number
          format: double
          description: Sum of amounts in this group
          example: 1000000.00
        average:
          type: number
          format: double
          description: Average amount in this group
          example: 10000.00
        min:
          type: number
          format: double
          description: Minimum amount in this group
          example: 500.00
        max:
          type: number
          format: double
          description: Maximum amount in this group
          example: 50000.00

    AnalyticsResponse:
      type: object
      properties:
        groupBy:
          type: string
          description: The field(s) used for grouping
          example: "status"
        totalCount:
          type: integer
          description: Total count of bill items across all groups
          example: 150
        totalSum:
          type: number
          format: double
          description: Total sum of amounts across all groups
          example: 1500000.00
        totalAverage:
          type: number
          format: double
          description: Average amount across all groups
          example: 10000.00
        totalMin:
          type: number
          format: double
          description: Minimum amount across all groups
          example: 500.00
        totalMax:
          type: number
          format: double
          description: Maximum amount across all groups
          example: 50000.00
        items:
          type: array
          description: Aggregated results for each group
          items:
            $ref: '#/components/schemas/AggregationResult'

  responses:
    BadRequest:
      description: Validation error or PayKaduna rejection
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Invalid API key or HMAC signature
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Bill or taxpayer not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalServerError:
      description: Server error or network failure
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
